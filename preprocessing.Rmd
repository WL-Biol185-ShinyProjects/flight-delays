---
title: "Pre-processing"
output: html_document
---

# Pre-processing to combine years of flights data

```{r}
library(tidyverse)
library(readr)
library(readxl)
```

```{r}
parse_table <- function(fileName) { 
                read_csv( file.path("data", fileName, fsep = "/")
                        , col_select = c( "FL_DATE"
                                        , "OP_CARRIER"
                                        , "OP_CARRIER_FL_NUM"
                                        , "ORIGIN"
                                        , "DEST"
                                        , "DEP_DELAY"
                                        , "ARR_DELAY"
                                        , "CANCELLED"
                                        , "CARRIER_DELAY"
                                        , "WEATHER_DELAY"
                                        , "NAS_DELAY"
                                        , "SECURITY_DELAY"
                                        , "LATE_AIRCRAFT_DELAY"
                                        )
                        , col_types = cols(OP_CARRIER = col_factor(levels = c( "9E"
                                                                             , "AA"
                                                                             , "MQ"
                                                                             , "G4"
                                                                             , "OH"
                                                                             , "B6"
                                                                             , "YV"
                                                                             , "EV"
                                                                             , "F9"
                                                                             , "YX"
                                                                             , "HA"
                                                                             , "NK"
                                                                             , "UA"
                                                                             , "OO"
                                                                             , "WN"
                                                                             , "AS"
                                                                             , "DL"
                                                                             )
                                                                   )
                                           )
                        )
}

count_carrier <- function(airline) {
  d <- flights[flights$OP_CARRIER == carrier, ] %>% select(2, 9)
  d <- d[d$CARRIER_DELAY > 0, ]
  d[!is.na(d$CARRIER_DELAY), ] %>% nrow()
} 

count_weather <- function(airline) {
  d <- flights[flights$OP_CARRIER == carrier, ] %>% select(2, 10)
  d <- d[d$WEATHER_DELAY > 0, ]
  d[!is.na(d$WEATHER_DELAY), ] %>% nrow()
} 

count_nas <- function(airline) {
  d <- flights[flights$OP_CARRIER == carrier, ] %>% select(2, 11)
  d <- d[d$NAS_DELAY > 0, ]
  d[!is.na(d$NAS_DELAY), ] %>% nrow()
} 

count_security <- function(airline) {
  d <- flights[flights$OP_CARRIER == carrier, ] %>% select(2, 12)
  d <- d[d$SECURITY_DELAY > 0, ]
  d[!is.na(d$SECURITY_DELAY), ] %>% nrow()
} 

count_late <- function(airline) {
  d <- flights[flights$OP_CARRIER == carrier, ] %>% select(2, 13)
  d <- d[d$LATE_AIRCRAFT_DELAY > 0, ]
  d[!is.na(d$LATE_AIRCRAFT_DELAY), ] %>% nrow()
} 
```

```{r}
# using non-vectorized to reduce memory consumption
# 2015-2018

flights <- data.frame()

for (n in c(2015:2018)) {
  file    <- paste0(n, ".csv")
  flights <- rbind(flights, parse_table(file))
  gc()
}

saveRDS(flights, file = "data/flights.rds")
```

# Carrier performance tables

```{r}
arr.delay   <- flights %>% 
                select(2,7)

saveRDS(arr.delay, "data/arrDelay.rds")
```

```{r}
delay.types <- data.frame( OP_CARRIER = unique(flights$OP_CARRIER) )


delay.types$CARRIER_DELAY <- sapply(delay.types$OP_CARRIER, function(x) {
                                                              d <- flights[flights$OP_CARRIER == x, ] %>% select(2, 9)
                                                              d <- d[d$CARRIER_DELAY > 0, ]
                                                              d[!is.na(d$CARRIER_DELAY), ] %>% nrow()  
                                                            }
                                   )

delay.types$WEATHER_DELAY <- sapply(delay.types$OP_CARRIER, function(x) {
                                                              d <- flights[flights$OP_CARRIER == x, ] %>% select(2, 10)
                                                              d <- d[d$WEATHER_DELAY > 0, ]
                                                              d[!is.na(d$WEATHER_DELAY), ] %>% nrow()  
                                                            }
                                   )

delay.types$NAS_DELAY <- sapply(delay.types$OP_CARRIER, function(x) {
                                                          d <- flights[flights$OP_CARRIER == x, ] %>% select(2, 11)
                                                          d <- d[d$NAS_DELAY > 0, ]
                                                          d[!is.na(d$NAS_DELAY), ] %>% nrow()  
                                                        }
                               )

delay.types$SECURITY_DELAY <- sapply(delay.types$OP_CARRIER, function(x) {
                                                              d <- flights[flights$OP_CARRIER == x, ] %>% select(2, 12)
                                                              d <- d[d$SECURITY_DELAY > 0, ]
                                                              d[!is.na(d$SECURITY_DELAY), ] %>% nrow()  
                                                             }
                                    )

delay.types$LATE_AIRCRAFT_DELAY <- sapply(delay.types$OP_CARRIER, function(x) {
                                                                   d <- flights[flights$OP_CARRIER == x, ] %>% select(2, 13)
                                                                   d <- d[d$LATE_AIRCRAFT_DELAY > 0, ]
                                                                   d[!is.na(d$LATE_AIRCRAFT_DELAY), ] %>% nrow()   
                                                                  }
                                         )

delay.types <- delay.types[-7,]
saveRDS(delay.types, file = "data/delay_types.rds")
```

# Cleaning the Review table

```{r}
reviews <- read_excel("data/capstone_airline_reviews3.xlsx")
```

```{r}
reviews <- reviews[1:2]
reviews <- reviews[!is.na(reviews$airline), ]

saveRDS(reviews, file = "data/reviews.rds")
```

```{r}
# read_csv_chunked allows for table streaming
```


